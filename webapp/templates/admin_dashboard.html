{% extends "base.html" %}

{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ†{% endblock %}
{% block page_title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ†{% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; align-items: flex-start; }
    .main-column, .sidebar-column { display: flex; flex-direction: column; gap: 1.5rem; }
    .user-list .usage { color: var(--accent-color); font-weight: 500; }
    .user-list.multi-column { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.25rem 1.5rem; padding: 25px; }
    .user-list.multi-column .user-list-item { padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); }
    .user-list.multi-column .user-list-item:nth-last-child(-n+2) { border-bottom: none; }
    @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }
    @media (max-width: 480px) {
        .user-list.multi-column { grid-template-columns: 1fr; }
        .user-list.multi-column .user-list-item { border-bottom: 1px solid var(--border-color) !important; }
        .user-list.multi-column .user-list-item:last-child { border-bottom: none !important; }
    }
</style>
{% endblock %}

{% block page_content %}
    {% include 'partials/_header.html' %}

    <section class="info-grid" style="margin-bottom: 1.5rem;">
        <div class="info-card"><div class="card-header"><i class="ri-group-line icon"></i><span>Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</span></div><div class="card-content">{{ stats.total_users | default('...') }}</div></div>
        <a href="{{ url_for('admin.user_management_page', key=admin_key, filter='active') }}" class="info-card clickable"><div class="card-header"><i class="ri-user-follow-line icon"></i><span>Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„</span></div><div class="card-content">{{ stats.active_users | default('...') }}</div></a>
        <a href="{{ url_for('admin.user_management_page', key=admin_key, filter='expiring_soon') }}" class="info-card clickable"><div class="card-header"><i class="ri-alarm-warning-line icon"></i><span>Ø¯Ø± Ø¢Ø³ØªØ§Ù†Ù‡ Ø§Ù†Ù‚Ø¶Ø§ (Û· Ø±ÙˆØ²)</span></div><div class="card-content">{{ stats.expiring_soon_count | default('...') }}</div></a>
        <a href="{{ url_for('admin.user_management_page', key=admin_key, filter='online') }}" class="info-card clickable"><div class="card-header"><i class="ri-wifi-line icon"></i><span>Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ† (Û³Ø¯Ù‚ÛŒÙ‚Ù‡)</span></div><div class="card-content">{{ stats.online_users | default('...') }}</div></a>
        <div class="info-card"><div class="card-header"><i class="ri-download-cloud-2-line icon"></i><span>Ù…ØµØ±Ù Ø§Ù…Ø±ÙˆØ²</span></div><div class="card-content">{{ stats.total_usage_today | default('...') }}</div></div>
        <div class="info-card"><div class="card-header"><i class="ri-user-add-line icon"></i><span>Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ (Û²Û´Ø³)</span></div><div class="card-content">{{ stats.new_users_today | default('...') }}</div></div>
    </section>
    
    <div class="dashboard-grid">
        <div class="main-column">
            <div class="info-card">
                <div class="card-header" style="margin-bottom: 1.5rem;"><i class="ri-bar-chart-line icon"></i><span>Ù…ØµØ±Ù Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ (GB)</span></div>
                <div id="usage-chart"></div>
            </div>
            <div class="info-card">
                 <div class="card-header"><i class="ri-pie-chart-2-line icon"></i><span>ØªÙÚ©ÛŒÚ© Ù¾Ù†Ù„â€ŒÙ‡Ø§ (Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„)</span></div>
                 <div id="panel-distribution-chart" style="min-height: 310px;"></div>
            </div>
            <div class="info-card">
                 <div class="card-header"><i class="ri-wifi-line icon"></i><span>Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†</span></div>
                 <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; padding-top: 1rem;">
                     <div>
                         <h4 style="text-align: center; margin-bottom: 1rem;">Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¯Ø± Hiddify ğŸ‡©ğŸ‡ª</h4>
                         <ul class="user-list">
                             {% for user in online_users_hiddify %}<li class="user-list-item"><span>{{ user.name }}</span></li>{% else %}<li>-</li>{% endfor %}
                         </ul>
                     </div>
                     <div>
                         <h4 style="text-align: center; margin-bottom: 1rem;">Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¯Ø± Marzban ğŸ‡«ğŸ‡·</h4>
                         <ul class="user-list">
                             {% for user in online_users_marzban %}<li class="user-list-item"><span>{{ user.name }}</span></li>{% else %}<li>-</li>{% endfor %}
                         </ul>
                     </div>
                 </div>
            </div>
            </div>

        <div class="sidebar-column">
            <div class="info-card">
                 <div class="card-header"><i class="ri-heart-pulse-line icon"></i><span>ÙˆØ¶Ø¹ÛŒØª Ø³Ù„Ø§Ù…Øª Ø³ÛŒØ³ØªÙ…</span></div>
                 <ul class="user-list">
                    <li class="user-list-item"><span>Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù¾Ù†Ù„ Hiddify</span><span class="status">{% if system_health.hiddify %}âœ…{% else %}âŒ{% endif %}</span></li>
                    <li class="user-list-item"><span>Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù¾Ù†Ù„ Marzban</span><span class="status">{% if system_health.marzban %}âœ…{% else %}âŒ{% endif %}</span></li>
                    <li class="user-list-item"><span>Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³</span><span class="status">{% if system_health.database %}âœ…{% else %}âŒ{% endif %}</span></li>
                 </ul>
            </div>
            <div class="info-card">
                <div class="card-header"><i class="ri-user-add-line icon"></i><span>Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯</span></div>
                <ul class="user-list">
                    {% for user in recent_users %}<li class="user-list-item"><span>{{ user.name }}</span><span class="date">{{ user.created_at.strftime('%Y/%m/%d') if user.created_at }}</span></li>{% else %}<li>Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</li>{% endfor %}
                </ul>
            </div>
            <div class="info-card">
                <div class="card-header"><i class="ri-fire-line icon"></i><span>Ù¾Ø±Ù…ØµØ±Ùâ€ŒØªØ±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</span></div>
                <ul class="user-list">
                    {% for user in top_consumers_today %}
                        {% if user.get('daily_usage_gb', 0) > 0 %}
                        <li class="user-list-item">
                            <span>{{ user.name }}</span>
                            <span class="usage">{{ "%.2f"|format(user.get('daily_usage_gb', 0)) }} GB</span>
                        </li>
                        {% endif %}
                    {% else %}
                        <li>Ù‡Ù†ÙˆØ² Ù…ØµØ±ÙÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="info-card">
                <div class="card-header"><i class="ri-time-line icon"></i><span>Ø¯Ø± Ø¢Ø³ØªØ§Ù†Ù‡ Ø§Ù†Ù‚Ø¶Ø§</span></div>
                <ul class="user-list multi-column">
                    {% for user in expiring_soon_users %}<li class="user-list-item"><span>{{ user.name }}</span><span class="days">{{ user.expire }} Ø±ÙˆØ²</span></li>{% else %}<li style="grid-column: 1 / -1;">Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</li>{% endfor %}
                </ul>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const isDarkTheme = document.body.classList.contains('dark-theme');
    const usageChartOptions = { series: [{ name: "Ù…ØµØ±Ù Ú©Ù„ (GB)", data: {{ usage_chart_data.data | tojson | safe }} }], chart: { type: 'area', height: 250, toolbar: { show: false }, fontFamily: 'Vazirmatn, sans-serif' }, dataLabels: { enabled: false }, stroke: { curve: 'smooth' }, xaxis: { categories: {{ usage_chart_data.labels | tojson | safe }} }, tooltip: { theme: isDarkTheme ? 'dark' : 'light' } };
    if (document.querySelector("#usage-chart")) { new ApexCharts(document.querySelector("#usage-chart"), usageChartOptions).render(); }
    const panelDistOptions = { series: {{ panel_distribution_data.data | tojson | safe }}, labels: {{ panel_distribution_data.labels | tojson | safe }}, chart: { type: 'donut', height: 310, fontFamily: 'Vazirmatn, sans-serif' }, plotOptions: { pie: { donut: { labels: { show: true, total: { show: true, label: 'Ù…Ø¬Ù…ÙˆØ¹ ÙØ¹Ø§Ù„' } } } } }, dataLabels: { enabled: true, formatter: function (val) { return Math.round(val) + "%" } }, legend: { position: 'bottom' }, tooltip: { theme: isDarkTheme ? 'dark' : 'light' } };
    if (document.querySelector("#panel-distribution-chart")) { new ApexCharts(document.querySelector("#panel-distribution-chart"), panelDistOptions).render(); }
});
</script>
{% endblock %}